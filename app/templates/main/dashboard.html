{% extends "base.html" %}

{% block title %}Dashboard - .smash{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Welcome Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold mb-2">
            Welcome back, <span class="text-mk-fire">{{ current_user.username }}</span>
        </h1>
        <p class="text-mk-text-secondary italic">"{{ current_user.tagline }}"</p>
    </div>

    <!-- Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Active Tournament Card -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">
                <span class="text-mk-fire">üèÜ</span> Your Tournaments
            </h2>

            {% set active = active_tournaments.in_progress %}
            {% set registered = active_tournaments.registered %}

            {% if active %}
                {% for tournament in active[:2] %}  <!-- Show max 2 active tournaments -->
                <div class="bg-mk-darker border border-mk-fire rounded-lg p-4 mb-4">
                    <!-- Tournament Header -->
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">{{ tournament.name }}</h3>
                        {% if tournament.status == 'group_stage' %}
                        <span class="text-xs bg-orange-500 bg-opacity-20 border border-orange-500 text-orange-500 px-2 py-1 rounded">
                            GROUP STAGE
                        </span>
                        {% elif tournament.status == 'playoffs' %}
                        <span class="text-xs bg-mk-fire bg-opacity-20 border border-mk-fire text-mk-fire px-2 py-1 rounded">
                            PLAYOFFS
                        </span>
                        {% endif %}
                    </div>

                    <!-- Mini Standings (Top 3) -->
                    {% if tournament.status == 'group_stage' %}
                    {% set standings = calculate_standings(tournament.id) %}
                    <div class="space-y-2 mb-3">
                        {% for standing in standings[:3] %}
                        <div class="flex items-center justify-between text-sm {% if standing.user.id == current_user.id %}text-mk-fire font-bold{% endif %}">
                            <div class="flex items-center gap-2">
                                <span class="w-6">
                                    {% if standing.position == 1 %}üî•{% else %}{{ standing.position }}.{% endif %}
                                </span>
                                <img src="{{ standing.user.avatar }}" class="w-6 h-6 rounded-full">
                                <span>{{ standing.user.username }}</span>
                            </div>
                            <div class="text-mk-fire font-bold">{{ standing.group_points }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Playoff Bracket (Compact) -->
                    {% if tournament.status in ['playoffs', 'completed'] %}
                    {% set playoff_matches = tournament.matches|selectattr('phase', 'equalto', 'playoff')|sort(attribute='bracket_round')|list %}
                    <div class="space-y-2 mb-3">
                        <div class="text-xs font-bold text-mk-text-secondary mb-2">
                            {% if tournament.status == 'completed' %}üèÜ Final Results{% else %}Gauntlet Bracket{% endif %}
                        </div>
                        {% for match in playoff_matches[:3] %}
                        <div class="flex items-center justify-between text-xs border border-mk-darkest rounded p-2
                                    {% if match.status == 'confirmed' %}bg-green-500 bg-opacity-5{% endif %}">
                            <div class="flex items-center gap-2">
                                <span class="text-mk-text-secondary">R{{ match.bracket_round }}:</span>
                                <span {% if match.winner_id == match.player1_id %}class="text-mk-fire font-bold"{% endif %}>
                                    {{ match.player1.username }}
                                </span>
                                <span class="text-mk-text-secondary">vs</span>
                                <span {% if match.winner_id == match.player2_id %}class="text-mk-fire font-bold"{% endif %}>
                                    {{ match.player2.username }}
                                </span>
                            </div>
                            {% if match.status == 'confirmed' %}
                                <span class="text-green-500">‚úì</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- View Details Button -->
                    <a href="{{ url_for('tournament.detail', tournament_id=tournament.id) }}"
                       class="text-mk-fire hover:text-mk-fire-light text-sm font-semibold">
                        View Full {% if tournament.status in ['playoffs', 'completed'] %}Bracket{% else %}Standings{% endif %} ‚Üí
                    </a>
                </div>
                {% endfor %}
            {% elif registered %}
                <!-- Registration Phase -->
                <div class="bg-mk-darker border border-yellow-500 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold">{{ registered[0].name }}</h3>
                        <span class="text-xs bg-yellow-500 bg-opacity-20 border border-yellow-500 text-yellow-500 px-2 py-1 rounded">
                            REGISTRATION
                        </span>
                    </div>
                    <p class="text-sm text-mk-text-secondary mb-3">
                        Waiting for more players to join...
                    </p>
                    <div class="text-xs text-mk-text-secondary">
                        {{ registered[0].player_count }} players registered
                    </div>
                    <a href="{{ url_for('tournament.detail', tournament_id=registered[0].id) }}"
                       class="text-mk-fire hover:text-mk-fire-light text-sm font-semibold mt-2 inline-block">
                        View Tournament ‚Üí
                    </a>
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">üéÆ</div>
                    <p class="text-mk-text-secondary mb-4">No active tournaments</p>
                    <a href="{{ url_for('tournament.list') }}" class="btn-primary inline-block">
                        Browse Tournaments
                    </a>
                </div>
            {% endif %}

            <!-- Pending Confirmations Alert -->
            {% if pending_confirmations %}
            <div class="mt-4 p-4 bg-yellow-500 bg-opacity-10 border border-yellow-500 rounded-lg">
                <div class="flex items-center gap-2 text-yellow-500 font-bold mb-2">
                    <span>‚ö†Ô∏è</span>
                    <span>{{ pending_confirmations|length }} match(es) need confirmation</span>
                </div>
                <p class="text-xs text-mk-text-secondary mb-3">
                    Your opponents have submitted scores. Please review and confirm.
                </p>

                <!-- Pending Matches List -->
                <div class="space-y-3 mt-4">
                    {% for match in pending_confirmations %}
                    <div class="bg-mk-darkest rounded-lg p-3">
                        <!-- Match Info -->
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <img src="{{ match.get_opponent(current_user.id).avatar }}" class="w-8 h-8 rounded-full">
                                <span class="font-semibold">vs {{ match.get_opponent(current_user.id).username }}</span>
                            </div>
                            <span class="text-xs text-mk-text-secondary">{{ match.tournament.name }}</span>
                        </div>

                        <!-- Set Scores -->
                        <div class="text-xs text-mk-text-secondary mb-3">
                            {% for set_score in match.set_scores|sort(attribute='set_number') %}
                            <span class="inline-block mr-2">
                                Set {{ set_score.set_number }}: {{ set_score.player1_score }}-{{ set_score.player2_score }}
                            </span>
                            {% endfor %}
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <form method="POST" action="{{ url_for('match.confirm', match_id=match.id) }}" class="flex-1">
                                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-colors">
                                    ‚úì Confirm
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('match.dispute', match_id=match.id) }}" class="flex-1">
                                <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition-colors">
                                    ‚úó Dispute
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Recent Matches Card -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">
                <span class="text-mk-fire">üìä</span> Your Recent Matches
            </h2>

            {% if recent_matches %}
            <div class="space-y-3">
                {% for match in recent_matches %}
                <div class="bg-mk-darker border border-mk-darkest rounded-lg p-4 hover:border-mk-fire transition-colors">
                    <!-- Players -->
                    <div class="flex items-center justify-between mb-2">
                        <!-- Player 1 -->
                        <div class="flex items-center gap-2 flex-1">
                            <img src="{{ match.player1.avatar }}" alt="{{ match.player1.username }}"
                                 class="w-8 h-8 rounded-full">
                            <span class="{% if match.player1_id == current_user.id %}font-bold{% endif %}
                                         {% if match.winner_id == match.player1_id %}text-green-500{% else %}text-red-500{% endif %}">
                                {{ match.player1.username }}
                            </span>
                        </div>

                        <!-- Score Display -->
                        <div class="px-3 py-1 bg-mk-darkest rounded text-sm font-mono">
                            {% set p1_sets = namespace(count=0) %}
                            {% set p2_sets = namespace(count=0) %}
                            {% for set_score in match.set_scores %}
                                {% if set_score.player1_score > set_score.player2_score %}
                                    {% set p1_sets.count = p1_sets.count + 1 %}
                                {% else %}
                                    {% set p2_sets.count = p2_sets.count + 1 %}
                                {% endif %}
                            {% endfor %}
                            <span class="{% if match.winner_id == match.player1_id %}text-green-500 font-bold{% endif %}">
                                {{ p1_sets.count }}
                            </span>
                            <span class="text-mk-text-secondary mx-1">-</span>
                            <span class="{% if match.winner_id == match.player2_id %}text-green-500 font-bold{% endif %}">
                                {{ p2_sets.count }}
                            </span>
                        </div>

                        <!-- Player 2 -->
                        <div class="flex items-center gap-2 flex-1 justify-end">
                            <span class="{% if match.player2_id == current_user.id %}font-bold{% endif %}
                                         {% if match.winner_id == match.player2_id %}text-green-500{% else %}text-red-500{% endif %}">
                                {{ match.player2.username }}
                            </span>
                            <img src="{{ match.player2.avatar }}" alt="{{ match.player2.username }}"
                                 class="w-8 h-8 rounded-full">
                        </div>
                    </div>

                    <!-- Match Details -->
                    <div class="flex justify-between text-xs text-mk-text-secondary mt-2">
                        <span>{{ match.tournament.name }}</span>
                        <span>{{ match.played_at.strftime('%b %d') if match.played_at else 'Recently' }}</span>
                    </div>

                    <!-- Individual Set Scores -->
                    <div class="mt-2 pt-2 border-t border-mk-darkest text-xs text-mk-text-secondary">
                        {% for set_score in match.set_scores|sort(attribute='set_number') %}
                        <span class="inline-block mr-3">
                            Set {{ set_score.set_number }}:
                            <span class="font-mono">{{ set_score.player1_score }}-{{ set_score.player2_score }}</span>
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-12">
                <div class="text-6xl mb-4">üéØ</div>
                <p class="text-mk-text-secondary">No matches played yet</p>
                <p class="text-sm text-mk-text-secondary mt-2">
                    Your match history will appear here
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Stats Card -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">
                <span class="text-mk-fire">üìà</span> Your Stats
            </h2>

            {% if stats.total > 0 %}
            <!-- Stats Grid -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <!-- Wins -->
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-500">{{ stats.wins }}</div>
                    <div class="text-xs text-mk-text-secondary mt-1">Wins</div>
                </div>

                <!-- Losses -->
                <div class="text-center">
                    <div class="text-3xl font-bold text-red-500">{{ stats.losses }}</div>
                    <div class="text-xs text-mk-text-secondary mt-1">Losses</div>
                </div>

                <!-- Win Rate -->
                <div class="text-center">
                    <div class="text-3xl font-bold text-mk-fire">{{ stats.win_rate }}%</div>
                    <div class="text-xs text-mk-text-secondary mt-1">Win Rate</div>
                </div>
            </div>

            <!-- Win Rate Bar -->
            <div class="mb-4">
                <div class="w-full bg-mk-darkest rounded-full h-4 overflow-hidden">
                    <div class="bg-gradient-to-r from-mk-fire to-mk-fire-light h-full transition-all duration-500"
                         style="width: {{ stats.win_rate }}%">
                    </div>
                </div>
            </div>

            <!-- Record Display -->
            <div class="text-center text-sm text-mk-text-secondary">
                Overall Record: <span class="text-mk-fire font-bold">{{ stats.wins }}-{{ stats.losses }}</span>
                <span class="text-xs">({{ stats.total }} matches)</span>
            </div>

            <!-- View Full Stats Link -->
            <div class="text-center mt-4">
                <a href="{{ url_for('stats.user_stats', user_id=current_user.id) }}"
                   class="text-mk-fire hover:text-mk-fire-light text-sm font-semibold">
                    View Full Stats ‚Üí
                </a>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-12">
                <div class="text-6xl mb-4">üìä</div>
                <p class="text-mk-text-secondary">No matches played</p>
                <p class="text-sm text-mk-text-secondary mt-2">
                    Play your first match to see stats
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Upcoming Matches Card -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">
                <span class="text-mk-fire">‚öîÔ∏è</span> Your Upcoming Matches
            </h2>

            {% if upcoming_matches %}
            <!-- Vertical List of Match Cards -->
            <div class="space-y-3">
                {% for match in upcoming_matches %}
                {% set opponent = match.get_opponent(current_user.id) %}
                <div class="bg-gradient-to-r from-mk-darkest to-mk-darker border {% if loop.first %}border-mk-fire{% else %}border-mk-darkest{% endif %} rounded-lg p-4 hover:border-mk-fire transition-colors">
                    <div class="flex items-center gap-4">
                        <!-- Opponent Avatar -->
                        <img src="{{ opponent.avatar }}" alt="{{ opponent.username }}"
                             class="w-14 h-14 rounded-full border-2 {% if loop.first %}border-mk-fire{% else %}border-mk-darkest{% endif %} flex-shrink-0">

                        <!-- Opponent Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-lg">{{ opponent.username }}</span>
                                <span class="px-2 py-0.5 bg-mk-fire text-mk-dark font-black text-xs rounded">VS</span>
                                {% if loop.first %}
                                <span class="text-xs text-mk-fire">Recommended</span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-mk-text-secondary truncate">"{{ opponent.tagline }}"</div>
                            <div class="text-xs text-mk-text-secondary mt-1">
                                {{ match.tournament.name }} ¬∑ <span class="text-mk-fire">{{ match.phase|upper }}</span>
                            </div>
                        </div>

                        <!-- Submit Score Button -->
                        <a href="{{ url_for('match.submit', match_id=match.id) }}"
                           class="px-4 py-2 {% if loop.first %}bg-mk-fire hover:bg-mk-fire-light text-mk-dark{% else %}bg-mk-darkest hover:bg-mk-fire text-white hover:text-mk-dark{% endif %} font-bold rounded transition-colors flex-shrink-0">
                            Submit Score
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-12">
                <div class="text-6xl mb-4">üèì</div>
                <p class="text-mk-text-secondary">No upcoming matches</p>
                <p class="text-sm text-mk-text-secondary mt-2">
                    Register for a tournament to get matched up!
                </p>
                <a href="{{ url_for('tournament.list') }}" class="btn-primary mt-4 inline-block">
                    Browse Tournaments
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
